name: Deploy FastAPI to EC2 (Direct Build)

on:
  push:
    branches: [ main ]
    paths:
      - "Dockerfile"
      - "requirements.txt"
      - "main.py"
      - "config/**"
      - "core/**"
      - "exception/**"
      - "models/**"
      - "routers/**"
      - "services/**"
      - ".github/workflows/deploy-fastapi.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # (루트 구조이므로 move 단계 불필요)

      - name: Copy files to EC2 (root-based layout)  # [수정]
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          source: |
            Dockerfile,
            requirements.txt,
            main.py,
            config/**,
            core/**,
            exception/**,
            models/**,
            routers/**,
            services/**
          target: "/home/ubuntu/Boini/fastapi"
          overwrite: true
          strip_components: 0

      - name: Build & Restart FastAPI via Docker Compose
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          script: |
            set -e
            cd /home/ubuntu/Boini

            echo "[1/4] docker compose 유효성 검사"
            docker compose config >/dev/null

            echo "[2/4] fastapi 빌드 & 재기동"
            docker compose up -d --build fastapi

            echo "[3/4] nginx 문법 테스트 & reload"
            docker exec nginx-container nginx -t
            docker exec nginx-container nginx -s reload

            echo "[4/4] 헬스체크 (재시도)"
            ok=0
            for i in $(seq 1 15); do
              if curl -fsS https://api.boini.shop/ai/healthz >/dev/null; then
                ok=1; echo "Health OK"; break
              fi
              echo "health not ready yet... ($i/15)"
              sleep 2
            done
            if [ "$ok" -ne 1 ]; then
              echo "::error::Health check failed. Showing fastapi logs..."
              docker logs --tail=200 fastapi-container || true
              exit 1
            fi

            echo "Deploy OK"
