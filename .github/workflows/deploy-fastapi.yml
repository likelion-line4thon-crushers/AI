name: Deploy FastAPI to EC2 (Direct Build)

on:
  push:
    branches: [ main ]
    paths:
      - "Dockerfile"
      - "requirements.txt"
      - "main.py"
      - "config/**"
      - "core/**"
      - "exception/**"
      - "models/**"
      - "routers/**"
      - "services/**"
      - ".github/workflows/deploy-fastapi.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # (ë£¨íŠ¸ êµ¬ì¡°ì´ë¯€ë¡œ move ë‹¨ê³„ ë¶ˆí•„ìš”)
      - name: Copy files to EC2 (root-based layout)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          source: |
            Dockerfile,
            requirements.txt,
            main.py,
            config/**,
            core/**,
            exception/**,
            models/**,
            routers/**,
            services/**
          target: "/home/ubuntu/Boini/fastapi"
          overwrite: true
          strip_components: 0

      - name: Build & Restart FastAPI via Docker Compose
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          script: |
            set -euo pipefail
            cd /home/ubuntu/Boini

            echo "[1/4] docker compose ìœ íš¨ì„± ê²€ì‚¬"
            docker compose config >/dev/null

            echo "[2/4] fastapi ë¹Œë“œ & ì¬ê¸°ë™"
            docker compose up -d --build fastapi

            echo "[3/4] nginx ë¬¸ë²• í…ŒìŠ¤íŠ¸ & reload"
            docker exec nginx-container nginx -t
            docker exec nginx-container nginx -s reload

            echo "[4/4] í—¬ìŠ¤ì²´í¬ (ë‚´ë¶€ â†’ ì™¸ë¶€ ìˆœì„œ)"

            # 4-1) ë‚´ë¶€: nginx ì»¨í…Œì´ë„ˆì—ì„œ fastapi ì—…ìŠ¤íŠ¸ë¦¼ ì§ì ‘ í™•ì¸ (/ai í”„ë¦¬í”½ìŠ¤ ìœ ì§€)
            if ! docker exec nginx-container bash -lc 'apt-get update >/dev/null && apt-get install -y curl >/dev/null && curl -fsS http://fastapi-container:8000/ai/healthz >/dev/null'; then
              echo "::error::âŒ nginx â†’ fastapi ë‚´ë¶€ í†µì‹  ì‹¤íŒ¨"
              docker logs nginx-container --tail=120 || true
              docker logs fastapi-container --tail=120 || true
              exit 1
            fi
            echo "âœ… ë‚´ë¶€ OK"

            # 4-2) ì™¸ë¶€: ë„ë©”ì¸(HTTPS) ì¬ì‹œë„ í™•ëŒ€
            ok=0
            for i in $(seq 1 30); do
              if curl -fsS https://api.boini.shop/ai/healthz >/dev/null; then
                ok=1; echo "âœ… ì™¸ë¶€ OK"; break
              fi
              echo "health not ready yet... ($i/30)"; sleep 2
            done

            if [ "$ok" -ne 1 ]; then
              echo "::error::âŒ ì™¸ë¶€ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ë‚´ë¶€ëŠ” OK)"
              docker logs nginx-container --tail=200 || true
              docker logs fastapi-container --tail=200 || true
              # ì™¸ë¶€ ì‹¤íŒ¨ë„ ì‹¤íŒ¨ë¡œ ì²˜ë¦¬í•˜ë ¤ë©´ ë‹¤ìŒ ì¤„ ì£¼ì„ í•´ì œ
              # exit 1
            fi

            echo "ğŸš€ Deploy OK"
